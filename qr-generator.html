<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Códigos QR</title>
    <link rel="stylesheet" href="styles.css">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef } = React;

        function App() {
            const [url, setUrl] = useState('');
            const [qrDataUrl, setQrDataUrl] = useState('');
            const [expirationMonths, setExpirationMonths] = useState(12);
            const [qrSize, setQrSize] = useState(256);
            const [includeMetadata, setIncludeMetadata] = useState(false);
            const [expirationDate, setExpirationDate] = useState(null);
            const canvasRef = useRef(null);

            const isValidUrl = (string) => {
                try {
                    new URL(string);
                    return true;
                } catch (_) {
                    return false;
                }
            };

            const generateQR = (e) => {
                e.preventDefault();
                
                if (!url.trim()) {
                    alert('Por favor ingresa una URL válida');
                    return;
                }

                if (!isValidUrl(url)) {
                    alert('Por favor ingresa una URL válida (debe comenzar con http:// o https://)');
                    return;
                }

                const expDate = new Date();
                expDate.setMonth(expDate.getMonth() + expirationMonths);
                setExpirationDate(expDate);

                let qrContent;
                if (includeMetadata) {
                    const metadata = {
                        url: url,
                        creado: new Date().toISOString(),
                        expira: expDate.toISOString(),
                        nota: 'Este QR contiene metadata. Tu aplicación debe validar la fecha de expiración.'
                    };
                    qrContent = JSON.stringify(metadata);
                } else {
                    qrContent = url;
                }

                try {
                    // Crear un div temporal para QRCode
                    const tempDiv = document.createElement('div');
                    const qr = new QRCode(tempDiv, {
                        text: qrContent,
                        width: qrSize,
                        height: qrSize,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.L
                    });

                    // Esperar un momento para que el canvas se genere
                    setTimeout(() => {
                        const canvas = tempDiv.querySelector('canvas');
                        if (canvas) {
                            setQrDataUrl(canvas.toDataURL());
                        } else {
                            alert('Error al generar el código QR');
                        }
                    }, 100);
                } catch (err) {
                    console.error('Error generando QR:', err);
                    alert('Error al generar el código QR: ' + err.message);
                }
            };

            const downloadQR = () => {
                if (!qrDataUrl) return;
                
                const link = document.createElement('a');
                link.download = `qr-code-${Date.now()}.png`;
                link.href = qrDataUrl;
                link.click();
            };

            const resetForm = () => {
                setUrl('');
                setQrDataUrl('');
                setExpirationDate(null);
            };

            return (
                <div className="container">
                    <header className="header">
                        <h1>Generador de Códigos QR</h1>
                        <p>Crea códigos QR para tus links con fecha de expiración</p>
                    </header>

                    <div className="content">
                        <div className="card">
                            <form onSubmit={generateQR}>
                                <div className="form-group">
                                    <label htmlFor="url">URL o Link</label>
                                    <input
                                        type="text"
                                        id="url"
                                        value={url}
                                        onChange={(e) => setUrl(e.target.value)}
                                        placeholder="https://ejemplo.com"
                                        className={url && !isValidUrl(url) ? 'invalid' : ''}
                                    />
                                    {url && !isValidUrl(url) && (
                                        <span className="error-text">URL no válida</span>
                                    )}
                                </div>

                                <div className="form-group">
                                    <label htmlFor="expiration">Expiración (meses)</label>
                                    <input
                                        type="number"
                                        id="expiration"
                                        min="1"
                                        max="60"
                                        value={expirationMonths}
                                        onChange={(e) => setExpirationMonths(parseInt(e.target.value) || 1)}
                                    />
                                    <span className="help-text">
                                        {expirationMonths} {expirationMonths === 1 ? 'mes' : 'meses'} desde ahora
                                    </span>
                                </div>

                                <div className="form-group">
                                    <label htmlFor="size">Tamaño del QR (px)</label>
                                    <input
                                        type="range"
                                        id="size"
                                        min="128"
                                        max="512"
                                        step="64"
                                        value={qrSize}
                                        onChange={(e) => setQrSize(parseInt(e.target.value))}
                                    />
                                    <span className="help-text">{qrSize}x{qrSize}px</span>
                                </div>

                                <div className="form-group">
                                    <div className="checkbox-group">
                                        <input
                                            type="checkbox"
                                            id="metadata"
                                            checked={includeMetadata}
                                            onChange={(e) => setIncludeMetadata(e.target.checked)}
                                        />
                                        <label htmlFor="metadata" style={{marginBottom: 0}}>
                                            Incluir metadata de expiración (JSON)
                                        </label>
                                    </div>
                                    <span className="help-text">
                                        {includeMetadata 
                                            ? 'El QR contendrá un JSON con la URL y fechas. Necesitarás una app que valide la fecha.'
                                            : 'El QR contendrá solo la URL. No hay validación real de expiración.'}
                                    </span>
                                </div>

                                <button type="submit" className="btn btn-primary">
                                    Generar QR
                                </button>

                                {qrDataUrl && (
                                    <button type="button" onClick={resetForm} className="btn btn-secondary">
                                        Nuevo QR
                                    </button>
                                )}
                            </form>
                        </div>

                        <div className="card">
                            {qrDataUrl ? (
                                <div className="qr-result">
                                    <div className="qr-container">
                                        <img src={qrDataUrl} alt="Código QR generado" />
                                    </div>

                                    <div className="qr-info">
                                        <h3>QR Generado</h3>
                                        {!includeMetadata && (
                                            <p><strong>URL:</strong> {url}</p>
                                        )}
                                        {expirationDate && (
                                            <p>
                                                <strong>Expira:</strong> {expirationDate.toLocaleDateString('es-ES', {
                                                    year: 'numeric',
                                                    month: 'long',
                                                    day: 'numeric'
                                                })}
                                            </p>
                                        )}
                                        
                                        {!includeMetadata ? (
                                            <div className="warning">
                                                <p><strong>Nota:</strong> Los códigos QR no expiran automáticamente. 
                                                La fecha mostrada es solo informativa. Para expiración real, usa un 
                                                servicio de acortamiento de URLs con expiración (Bitly, TinyURL, etc.).</p>
                                            </div>
                                        ) : (
                                            <div className="info-box">
                                                <p><strong>Metadata incluida:</strong> Este QR contiene un JSON con la URL y las fechas. 
                                                Tu aplicación debe leer este JSON y validar la fecha de expiración.</p>
                                            </div>
                                        )}
                                    </div>

                                    <button onClick={downloadQR} className="btn btn-download">
                                        Descargar QR
                                    </button>
                                </div>
                            ) : (
                                <div className="qr-placeholder">
                                    <div className="placeholder-icon">QR</div>
                                    <p>Ingresa una URL y haz clic en "Generar QR"</p>
                                    <p style={{fontSize: '0.875rem', opacity: 0.7}}>
                                        El código QR aparecerá aquí
                                    </p>
                                </div>
                            )}
                        </div>
                    </div>

                    <footer className="footer">
                        <p>Desarrollado con React - Los QR se generan localmente en tu navegador</p>
                    </footer>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
